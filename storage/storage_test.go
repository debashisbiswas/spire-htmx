package storage

import (
	"os"
	"spire/entry"
	"testing"
	"time"

	"golang.org/x/exp/rand"
)

func TestStorage(t *testing.T) {
	testDatabasePath := "storage_test.db"

	store, err := NewSQLiteStorage(testDatabasePath)

	if err != nil {
		t.Errorf("error creating storage: %v\n", err)
	}

	defer func() {
		os.Remove(testDatabasePath)
	}()

	randomEmbeddings := generateRandomEmbeddings()

	originalEntries := []entry.Entry{
		{
			Time:      time.Now(),
			Content:   "welcome to the playground",
			Embedding: randomEmbeddings,
		},
		{
			Time:      time.Now(),
			Content:   "follow me",
			Embedding: randomEmbeddings,
		},
	}

	for _, e := range originalEntries {
		err = store.SaveEntry(e)
		if err != nil {
			t.Errorf("error saving entry: %v\n", err)
			t.FailNow()
		}
	}

	entries, err := store.GetEntries()
	if err != nil {
		t.Errorf("error getting entries: %v\n", err)
		t.FailNow()
	}

	if len(entries) != len(originalEntries) {
		t.Errorf("found %d entries, but original had %d", len(entries), len(originalEntries))
		t.FailNow()
	}

	searchResult, err := store.SearchEntries("playground")
	if err != nil {
		t.Errorf("error searching entries: %v\n", err)
		t.FailNow()
	}

	if len(searchResult) != 1 {
		t.Errorf("search found %d entries, but expected %d", len(searchResult), 1)
		t.FailNow()
	}

	foundEmbedding := searchResult[0].Embedding
	expectedEmbedding := randomEmbeddings

	if len(foundEmbedding) != len(expectedEmbedding) {
		t.Errorf("embedding length is incorrect: found %d, expected %d", len(foundEmbedding), len(expectedEmbedding))
		t.FailNow()
	}

	_, err = store.SearchEntriesEmbedding(greetingEmbeddings)
	if err != nil {
		t.Errorf("error getting entries by embedding: %v\n", err)
		t.FailNow()
	}
}

func generateRandomEmbeddings() entry.Vector {
	rand.Seed(42)

	result := make(entry.Vector, 512)

	for i := range result {
		result[i] = rand.Float32()
	}

	return result
}

// Embeddings for the string "greeting"
var greetingEmbeddings entry.Vector = entry.Vector{
	0.007463111,
	-0.0058574113,
	0.027907513,
	0.021937024,
	0.0037372094,
	-0.017866235,
	-0.024334265,
	0.05662918,
	0.0620569,
	-0.06603722,
	0.026233966,
	0.034760006,
	-0.007463111,
	0.10783065,
	0.055453178,
	0.021213328,
	0.007378303,
	-0.034058925,
	-0.010403125,
	-0.019811168,
	0.06802739,
	0.0010855434,
	-0.015256974,
	0.028458765,
	0.09824168,
	0.009159273,
	0.0073274183,
	0.025804272,
	0.00902358,
	-0.034466006,
	-0.033041228,
	-0.07580712,
	-0.041522037,
	0.055815026,
	0.0408888,
	-0.011058974,
	-0.04446205,
	-0.0036637092,
	-0.0043817507,
	0.041137572,
	-0.0059082964,
	-0.030304754,
	-0.048035298,
	-0.03672755,
	-0.01754962,
	0.009046195,
	0.03238538,
	0.10348848,
	-0.055000868,
	0.10457402,
	-0.04414543,
	-0.09118565,
	0.040074646,
	-0.0915475,
	0.067303695,
	-0.017979313,
	0.064137526,
	0.07707358,
	0.03808448,
	0.07399788,
	0.044688206,
	0.027997974,
	-0.029852444,
	0.0351897,
	0.02636966,
	0.02822413,
	-0.024198573,
	0.0077571124,
	-0.008141575,
	0.055362716,
	0.062418748,
	0.04812576,
	0.021077635,
	-0.018567316,
	-0.01673546,
	-0.0620569,
	-0.059885815,
	0.009345851,
	0.010312662,
	-0.021139828,
	0.08792902,
	0.02867644,
	-0.08991918,
	-0.10276478,
	0.011760054,
	-0.032204457,
	-0.042788506,
	0.068208314,
	0.030666603,
	0.039260488,
	0.036049087,
	-0.0070560323,
	0.04125065,
	0.12266641,
	0.04414543,
	-0.019517167,
	0.01609092,
	0.0026233967,
	0.05979535,
	-0.026098274,
	-0.022796413,
	-0.07010801,
	-0.04116019,
	-0.03754171,
	-0.029581059,
	0.089557335,
	-0.07074124,
	0.004771868,
	0.03193307,
	-0.04948269,
	-0.05880027,
	-0.005518179,
	-0.008316846,
	-0.021213328,
	0.043421738,
	0.034918316,
	-0.033222154,
	-0.029716752,
	0.029581059,
	-0.11108728,
	0.008865272,
	0.004291289,
	-0.009679429,
	-0.025600733,
	-0.0021710868,
	-0.029581059,
	-0.03301861,
	0.00927235,
	-0.013071752,
	0.09353766,
	-0.013292253,
	0.04812576,
	0.007203033,
	-0.0012664674,
	-0.05056823,
	-0.041522037,
	-0.05246793,
	-0.02080625,
	-0.09299489,
	-0.017866235,
	0.10113646,
	-0.003618478,
	0.021891793,
	0.012438519,
	0.030485678,
	0.11723869,
	-0.010657549,
	0.026324429,
	-0.009860353,
	-0.0703794,
	0.027952744,
	0.024831805,
	0.022117948,
	0.047944836,
	0.028857363,
	0.050839618,
	-0.051201466,
	-0.02456042,
	0.03980326,
	0.089557335,
	-0.048939917,
	-0.0016898894,
	0.05975012,
	-0.10041277,
	-0.0030983218,
	0.0054503325,
	0.00601572,
	0.03482785,
	-0.07725451,
	-0.034058925,
	-0.0036863247,
	0.0454119,
	-0.0065471837,
	-0.0068751085,
	-0.07083171,
	-0.016034381,
	-0.03944141,
	-0.0012664674,
	0.04459774,
	-0.012936059,
	0.01749308,
	-0.04631652,
	0.03473739,
	0.051111005,
	-0.030711833,
	0.055453178,
	0.015378532,
	-0.06929386,
	-0.008209422,
	-0.06766554,
	0.055453178,
	0.008051114,
	0.042743273,
	0.05418671,
	0.017730543,
	-0.012800367,
	-0.029128749,
	-0.015921304,
	-0.06079043,
	-0.024718728,
	0.03347092,
	-0.016803307,
	0.03699894,
	-0.058076575,
	-0.03453385,
	-0.012167132,
	-0.0022263005,
	-0.013365754,
	0.013998987,
	-0.028585978,
	0.018635163,
	0.02466219,
	-0.016831577,
	-0.024990115,
	-0.006321029,
	-0.024696114,
	0.017911466,
	0.02125856,
	-0.052106086,
	-0.00013569293,
	-0.027196538,
	0.10240293,
	0.12628488,
	-0.046497446,
	-0.03374231,
	-0.049392227,
	-0.012302825,
	-0.04034603,
	-0.0020353938,
	0.029490598,
	0.031118913,
	-0.019155318,
	-0.021575175,
	-0.031164143,
	-0.0030757063,
	0.025224043,
	0.060428586,
	0.027257318,
	-0.03238538,
	-0.037270326,
	-0.11217282,
	0.05047777,
	-0.045592826,
	-0.02596258,
	-0.02867644,
	0.048849456,
	-0.034466006,
	-0.0064227986,
	0.0035958625,
	0.011974901,
	0.00062475284,
	0.062418748,
	0.04269804,
	-0.09299489,
	-0.01112682,
	0.051563315,
	0.00029400134,
	0.03853679,
	0.036931094,
	-0.03609432,
	-0.06838924,
	0.07526434,
	-0.012472441,
	-0.0069655706,
	0.046949755,
	-0.06838924,
	0.050658695,
	-0.028631208,
	0.0026007812,
	-0.018861318,
	0.08412962,
	0.010131739,
	-0.010493587,
	0.04486913,
	-0.02035394,
	-0.003132245,
	-0.12013347,
	0.010855434,
	-0.10113646,
	-0.016260536,
	0.015310685,
	0.055905487,
	-0.04722114,
	-0.060519047,
	0.022886874,
	-0.0118279,
	0.05093008,
	0.013116983,
	-0.022027485,
	-0.00972466,
	-0.026686275,
	-0.062237825,
	-0.07236956,
	0.09064288,
	0.010764972,
	0.06296152,
	0.04125065,
	-0.0696557,
	-0.030214293,
	-0.017956698,
	0.018024543,
	-0.0077005737,
	-0.017538311,
	0.022027485,
	-0.03292815,
	0.005925258,
	-0.04866853,
	0.0037711326,
	0.045683287,
	0.04577375,
	0.03374231,
	-0.074721575,
	-0.07309326,
	0.026776738,
	-0.03609432,
	0.026658006,
	0.02731951,
	0.03419462,
	-0.014519144,
	0.041883886,
	-0.04251712,
	-0.019765936,
	0.031910453,
	-0.00052015623,
	-0.018816086,
	0.012427211,
	-0.018318545,
	0.010171316,
	-0.05509133,
	-0.04215527,
	-0.0072680525,
	0.01999209,
	0.011714823,
	0.036410935,
	-0.029776825,
	0.0028043205,
	0.014786289,
	0.0035697136,
	0.10095554,
	-0.02731951,
	-0.03537062,
	0.021835255,
	0.065946765,
	0.0071238787,
	0.06079043,
	0.017504388,
	-0.02551027,
	0.038265407,
	-0.0083225,
	0.007949344,
	0.0005880027,
	0.013840679,
	-0.05834796,
	0.027794436,
	0.0039449893,
	0.025600733,
	0.054096248,
	-0.046497446,
	-0.0064680297,
	0.0017187771,
	0.029038288,
	0.06603722,
	-0.0066941846,
	-0.025374578,
	0.024650883,
	0.05002546,
	0.002781705,
	0.026505353,
	-0.0351897,
	-0.027138585,
	0.006287106,
	0.028812133,
	-0.05138239,
	-0.0627806,
	0.015604687,
	-0.004025557,
	0.028800825,
	0.07454065,
	-0.01990163,
	0.063685216,
	0.062237825,
	-0.04369312,
	-0.10222201,
	-0.04966361,
	-0.0537344,
	-0.036456168,
	-0.008593885,
	0.0046248673,
	-0.072912335,
	-0.08051114,
	-0.06572061,
	-0.08268222,
	0.09498505,
	-0.025894735,
	0.04640698,
	0.018476853,
	0.05273932,
	-0.05228701,
	-0.022027485,
	-0.009656814,
	0.048487607,
	0.059885815,
	-0.017153848,
	0.025091885,
	-0.032747228,
	-0.006942955,
	0.0490643,
	-0.03148076,
	0.04812576,
	0.005088485,
	0.00085938856,
	0.035008777,
	-0.02220841,
	-0.00395771,
	-0.026075657,
	0.03053091,
	0.042426657,
	-0.004101884,
	-0.028947825,
	-0.02867644,
	0.07399788,
	0.01598915,
	-0.059162118,
	0.07273141,
	-0.0033470923,
	-0.010906319,
	0.09371858,
	-0.024334265,
	0.025103193,
	-0.012189748,
	-0.0029400135,
	0.069112934,
	0.032656766,
	0.024379496,
	-0.013795448,
	0.028563362,
	-0.008777636,
	0.03482785,
	0.049754076,
	0.10602141,
	0.00082405185,
	-0.0059874505,
	0.08557701,
	-0.03057614,
	0.009227119,
	-0.05187993,
	0.009996045,
	-0.03568724,
	-0.021071982,
	-0.0017074693,
	-0.0028947825,
	-0.02917398,
	0.004183865,
	0.026053043,
	0.03564201,
	0.023949802,
	-0.0026686275,
	0.061333206,
	-0.038582023,
	0.04785437,
	-0.029739367,
	0.05382486,
	-0.0046135597,
	0.05011592,
	0.06060951,
	0.09371858,
	0.029739367,
	0.03437554,
	0.049392227,
	-0.059523966,
	-0.029253135,
	0.07978744,
	-0.04369312,
	-0.024786575,
	-0.086843476,
	0.03392323,
	0.05789565,
	0.017504388,
	0.011963593,
	-0.07616896,
	-0.047492526,
	0.031887837,
	-0.03166168,
	-0.08792902,
	0.04957315,
	0.04766497,
	-0.014066834,
	0.0023520107,
	-0.008299884,
	0.06676092,
	0.012268903,
	-0.013659755,
	-0.0064227986,
	0.08666255,
	-0.046045136,
	-0.032701995,
	0.03853679,
	-0.0013569293,
	0.035461087,
	0.026279198,
	0.0014021603,
	0.021575175,
	-0.04206481,
	0.053915326,
	-0.014971454,
	0.0047944835,
	0.10638326,
	0.00011307744,
	-0.01819416,
	0.019087473,
	-0.032973383,
	0.010651895,
}
